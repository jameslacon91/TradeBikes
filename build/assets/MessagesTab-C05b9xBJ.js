import{c as S,u as F,a as q,r as l,d as O,e as b,j as s,M as U,E as N,y as v,C as w,f as $,g as K,h as L,F as P,T as R,B,k as M,H as C}from"./index-BpSmGhpl.js";import{A as I,a as E}from"./avatar-C2h3vRl_.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=S("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),z=()=>{const{user:t}=F(),{toast:m}=q(),[o,g]=l.useState(""),[r,x]=l.useState(null),[i,A]=l.useState({}),{data:u,isLoading:T,error:k}=O({queryKey:["/api/messages"],queryFn:async()=>{const e=await fetch("/api/messages");if(!e.ok)throw new Error("Failed to fetch messages");return e.json()},enabled:!!t}),h=b({mutationFn:async e=>{const a=await M("PATCH",`/api/messages/${e}/read`);if(!a.ok)throw new Error("Failed to mark message as read");return a.json()},onSuccess:()=>{C.invalidateQueries({queryKey:["/api/messages"]})},onError:e=>{m({title:"Error",description:e.message,variant:"destructive"})}}),y=b({mutationFn:async e=>{const a=await M("POST","/api/messages",e);if(!a.ok)throw new Error("Failed to send message");return a.json()},onSuccess:()=>{g(""),C.invalidateQueries({queryKey:["/api/messages"]}),m({title:"Message sent",description:"Your message has been sent successfully"})},onError:e=>{m({title:"Error",description:e.message,variant:"destructive"})}});l.useEffect(()=>{var e;if(u){const a={};if(u.forEach(n=>{const d=n.senderId===(t==null?void 0:t.id)?n.receiverId:n.senderId,c=n.senderId!==(t==null?void 0:t.id);if(!a[d]){const j=n.otherUser??{id:d,username:`User ${d}`,companyName:`Company ${d}`};a[d]={userId:d,username:j.username,companyName:j.companyName,messages:[],unreadCount:0,lastMessage:n}}a[d].messages.push(n),c&&!n.read&&(a[d].unreadCount+=1);const D=a[d].lastMessage;new Date(n.createdAt)>new Date(D.createdAt)&&(a[d].lastMessage=n)}),Object.values(a).forEach(n=>{n.messages.sort((d,c)=>new Date(d.createdAt).getTime()-new Date(c.createdAt).getTime())}),A(a),r===null&&Object.keys(a).length>0){const n=(e=Object.values(a).sort((d,c)=>new Date(c.lastMessage.createdAt).getTime()-new Date(d.lastMessage.createdAt).getTime())[0])==null?void 0:e.userId;x(n)}}},[u,t==null?void 0:t.id,r]),l.useEffect(()=>{r&&i[r]&&i[r].messages.filter(a=>a.receiverId===(t==null?void 0:t.id)&&!a.read).map(a=>a.id).forEach(a=>{h.mutate(a)})},[r,i,t==null?void 0:t.id,h]);const f=e=>{e.preventDefault(),!(!r||!o.trim())&&y.mutate({receiverId:r,content:o.trim()})},p=Object.values(i).reduce((e,a)=>e+a.unreadCount,0);return T?s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full","aria-label":"Loading"})}):k?s.jsx("div",{className:"p-4 text-center",children:s.jsx("p",{className:"text-red-500",children:"Error loading messages. Please try again."})}):s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 h-full",children:[s.jsxs("div",{className:"md:col-span-1 overflow-y-auto max-h-[70vh] border border-gray-700 rounded-md",children:[s.jsx("div",{className:"sticky top-0 bg-gray-900 p-4 border-b border-gray-700",children:s.jsxs("h3",{className:"text-lg font-bold text-white flex items-center",children:[s.jsx(U,{className:"mr-2"}),"Messages",p>0&&s.jsx(N,{variant:"destructive",className:"ml-2",children:p})]})}),s.jsx("div",{className:"divide-y divide-gray-700",children:Object.values(i).length===0?s.jsx("div",{className:"p-4 text-center text-gray-400",children:"No messages found."}):Object.values(i).sort((e,a)=>new Date(a.lastMessage.createdAt).getTime()-new Date(e.lastMessage.createdAt).getTime()).map(e=>s.jsx("div",{className:`p-3 cursor-pointer hover:bg-gray-800 ${r===e.userId?"bg-gray-800":""}`,onClick:()=>x(e.userId),children:s.jsxs("div",{className:"flex items-start",children:[s.jsx(I,{className:"h-10 w-10 mr-3",children:s.jsx(E,{className:"bg-primary text-white",children:e.companyName.substring(0,2).toUpperCase()})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("p",{className:"font-medium text-white truncate",children:e.companyName}),s.jsx("p",{className:"text-xs text-gray-400",children:v(new Date(e.lastMessage.createdAt),"MMM d, h:mm a")})]}),s.jsxs("p",{className:"text-sm text-gray-300 truncate",children:[e.lastMessage.senderId===(t==null?void 0:t.id)?"You: ":"",e.lastMessage.content]}),e.unreadCount>0&&s.jsxs(N,{variant:"destructive",className:"mt-1",children:[e.unreadCount," new"]})]})]})},e.userId))})]}),s.jsx("div",{className:"md:col-span-2 flex flex-col h-full",children:r&&i[r]?s.jsxs(w,{className:"flex flex-col h-full border border-gray-700 bg-gray-900",children:[s.jsx($,{className:"bg-gray-800 border-b border-gray-700 py-4",children:s.jsxs(K,{className:"text-white flex items-center",children:[s.jsx(I,{className:"h-8 w-8 mr-2",children:s.jsx(E,{className:"bg-primary text-white",children:i[r].companyName.substring(0,2).toUpperCase()})}),i[r].companyName]})}),s.jsx(L,{className:"flex-1 overflow-y-auto p-4 space-y-4",children:i[r].messages.map(e=>s.jsx("div",{className:`flex items-start ${e.senderId===(t==null?void 0:t.id)?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[80%] p-3 rounded-lg ${e.senderId===(t==null?void 0:t.id)?"bg-primary text-white ml-auto":"bg-gray-800 text-white"}`,children:[s.jsx("p",{children:e.content}),s.jsx("p",{className:"text-xs opacity-70 mt-1",children:v(new Date(e.createdAt),"MMM d, h:mm a")})]})},e.id))}),s.jsx(P,{className:"border-t border-gray-700 p-3 mt-auto",children:s.jsxs("form",{onSubmit:f,className:"flex w-full gap-2",children:[s.jsx(R,{className:"flex-1 bg-gray-800 border-gray-700 focus:border-gray-500",placeholder:"Type your message...",value:o,onChange:e=>g(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),f(e))}}),s.jsx(B,{type:"submit",className:"h-full",disabled:!o.trim()||y.isPending,children:s.jsx(H,{className:"h-5 w-5"})})]})})]}):s.jsx(w,{className:"flex items-center justify-center h-full border border-gray-700 bg-gray-900",children:s.jsx("p",{className:"text-gray-400",children:"Select a conversation to view messages"})})})]})};export{z as default};
